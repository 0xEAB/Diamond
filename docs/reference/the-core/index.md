[Home](https://diamondmvc.github.io/Diamond/) | [Download](https://diamondmvc.github.io/Diamond/download) | [Documentation](https://diamondmvc.github.io/Diamond/docs) | [Tutorials](https://diamondmvc.github.io/Diamond/tutorials) | [Contributing](https://diamondmvc.github.io/Diamond/contributing)

<br>

# Understanding The Core

The core of Diamond operates in a complex way since there are 3 types of applications it needs to support; one without any dependencies such as vibe.d. In order to contribute to Diamond it's important to understand the flow of Diamond's core.

Below is a description of each application type and the important calls of their call chain.

## WebServer

A web-server is used to server web-pages that are generated by the Diamond template engine.

### Compile-time

* mixin GenerateViews -- init/web.d
  * Parses and generates the views
* mixin template GenerateViews() -- views/viewgenerator.d
  * The mixin template for parsing and generating the views
* string[] generateViews() -- views/viewgenerator.d
  * The function that's parsing and generating the views and returning the string to use with mixin
* mixin template LoadViewData(bool namesOnly = false) -- core/webconfig.d
  * The mixin template that gets the views from config/views.config to parse and generate code of
* auto parseTemplate(string content) -- templates/parser.d
  * Parses the content of a view and returns the corresponding parts that will be used to generate the view class
* string parseViewParts(Part[][string] allParts, string viewName, out string route) -- views/viewparser.d
  * Parses the view parts
* creates: enum generateViewsResult
  * An enum that holds a string to be used with mixin for actually creating the generated views
* mixin(generateViewsResult.join("")) -- init/web.d
  * Will mixin the result into web.d, which means you can access all the views from the diamondapp or the diamond.init.web module
* mixin GenerateGetView -- init/web.d
  * Will mixin the getView() function which is used to route views
* mixin template GenerateGetView -- views/viewroute.d
  * The actual mixin template for generating the getView() function
* string generateGetView() -- views/viewroute.d
  * The actual function that generates the getView() function

### Run-time

* shared static this() -- init/web.d
  * The actual entry point of the web-server
* void loadWebConfig() -- core/webconfig.d
  * Loads the web configurations
* void loadStaticFiles() -- init/web.d
  * Loads the static file handlers
* void loadServer(string[] ipAddresses, ushort port) -- init/web.d
  * Loads the actual servers with their respective configurations

### Per-request

* void handleHTTPListen(HTTPServerRequest request, HTTPServerResponse response) -- init/web.d
  * The handler for each requests. Transforms the request & response into HttpClient.
* void handleWebServer(HttpClient client) -- init/server.d
  * The handler for each requests when using a web-server application.
* View getView(HttpClient client, Route route, bool checkRoute) -- views/viewroute.d
  * Gets the view based on the route. (This is used internally too by views/view.d to render views, layouts etc.)
* string generate(string sectionName = null) -- views/view.d
  * Generates the actual html of the view. This function is override by the actual generated view classes.
  * It should be obvious what code is generated by looking at views/viewformats.d and views/viewparser.d
  * This function also handles controller actions for views.

## WebApi

Web-apis are different from web-servers in the way they serve data only from controller actions.

### Compile-time

* string[] generateControllerData() -- core/webconfig.d
  * The function that gets the controllers to handle from config/controllers.config
* creates: enum controllerData -- init/web.d
  * A compile-time array of the controllers to handle
* mixin GenerateControllers!(controllerData) -- init/web.d
  * Will mixin the controllers to handle
* mixin template GenerateControllers(string[] controllerInitializers) -- controllers/controller.d
  * The actual mixin template to generate the controller handlers

### Run-time

* shared static this() -- init/web.d
  * The actual entry point of the web-server
* void loadWebConfig() -- core/webconfig.d
  * Loads the web configurations
* void loadStaticFiles() -- init/web.d
  * Loads the static file handlers
* void loadServer(string[] ipAddresses, ushort port) -- init/web.d
  * Loads the actual servers with their respective configurations

### Per-request

* void handleHTTPListen(HTTPServerRequest request, HTTPServerResponse response) -- init/web.d
  * The handler for each requests. Transforms the request & response into HttpClient.Â¨
* void handleWebApi(HttpClient client)
  * The handler for each requests when using a web-api application.
* GenerateControllerAction getControllerAction(string name) -- controllers/controller.d
  * Gets the controller to handle by its name
* final override Status handle() -- controllers/controller.d
  * Handles the current request and routes it to the correct mapped actions

## Stand-alone

Standa-lone is very different from web-servers and web-apis, because it's not an actual engine running.

When Diamond is used standalone you only have access to two parts of the Diamond library: The template engine and parts of the view engine.

### Compile-time

* mixin GenerateViews -- init/diamondapp.d
  * Parses and generates the views
* mixin template GenerateViews() -- views/viewgenerator.d
  * The mixin template for parsing and generating the views
* string[] generateViews() -- views/viewgenerator.d
  * The function that's parsing and generating the views and returning the string to use with mixin
* mixin template LoadViewData(bool namesOnly = false) -- core/webconfig.d
  * The mixin template that gets the views from config/views.config to parse and generate code of
* auto parseTemplate(string content) -- templates/parser.d
  * Parses the content of a view and returns the corresponding parts that will be used to generate the view class
* string parseViewParts(Part[][string] allParts, string viewName, out string route) -- views/viewparser.d
  * Parses the view parts
* creates: enum generateViewsResult
  * An enum that holds a string to be used with mixin for actually creating the generated views
* mixin(generateViewsResult.join("")) -- diamondapp.d
  * Will mixin the result into diamondapp.d, which means you can access all the views from the diamondapp module
* mixin GenerateGetView -- diamondapp.d
  * Will mixin the getView() function which is used to route views
* mixin template GenerateGetView -- views/viewroute.d
  * The actual mixin template for generating the getView() function
* string generateGetView() -- views/viewroute.d
  * The actual function that generates the getView() function

### Run-time

The run-time of stand-alone applications is up to the indivudal developer.
